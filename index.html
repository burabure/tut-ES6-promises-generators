<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">

    <title>Promesas, Generadores y Async en ES6</title>

    <meta name="description" content="">
    <meta name="author" content="Bura Bure (Nicolás Fernández)">

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="css/reveal.min.css">
    <link rel="stylesheet" href="css/theme/moon.css" id="theme">

    <!-- For syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- If the query includes 'print-pdf', include the PDF print sheet -->
    <script>
      if( window.location.search.match( /print-pdf/gi ) ) {
        var link = document.createElement( 'link' );
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = 'css/print/pdf.css';
        document.getElementsByTagName( 'head' )[0].appendChild( link );
      }
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->

    <style>
      div.avatar  {
        display: inline-block;
        vertical-align: top;
        background-image: url('img/avatar.jpg');
        background-size: cover;
        border-radius: 80px;
        width: 46px;
        height: 46px;
        margin: -10px 10px 0 0;
        vertical-align: middle;
      }

      .profile {
        text-align: left;
        vertical-align: middle !important;
      }

      .reveal p {
        margin-bottom: 20px;
      }

      section .content {
        max-width: 960px;
        margin: 0 auto;
      }

      section.code {
        width: 100%;
        height: 100%;
      }

      iframe {
        display: none; /* prevenir descuadre de reveal.js */
      }

      .code iframe {
        width: 100%;
        height: 100%;
        min-height: 430px;
        display: block;
      }

      .present iframe {
        width: 100%;
        height: 100%;
        min-height: 430px;
        display: block;
      }

      .code iframe.present {
        max-width: 100%;
        max-height: 100%;
        width: 100% !important;
        height: 90% !important;
        position: absolute;
        top: 3.9%;
        left: 0;
        right: 0;
        bottom: 0;
        display: block;
      }

      .codigoGigante code {
        font-size: 16px;
      }

      .reveal table {
        margin: 0 auto;
      }
      .reveal table th, .reveal table td {
        text-align: left;
        border: 1px solid #999;
        margin: 0;
        padding: 12px;
      }
    </style>
  </head>

  <body>

    <div class="reveal">

      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">

        <!-- Slide -->
        <section data-markdown>
          <script type="text/template">
              ## código Asíncrono
              ## en ES6/7

              ![http://goo.gl/86v9kK](http://chart.googleapis.com/chart?cht=qr&chs=150x150&choe=UTF-8&chld=H&chl=http://goo.gl/86v9kK)

              <small>http://goo.gl/86v9kK</small>
              <small class="profile">
                <div class="avatar"></div>
                Bura Bure (Nicolás Fernández) <br>
                CTOWTFOMGBBQ!!1! en [SantiagoLab.cl](http://santiagolab.cl) <br>
                @elburabure
                </small>
          </script>
        </section>


        <!-- Slide -->
        <section data-markdown>
          <script type="text/template">
              ## ES5.1 y código asíncrono

              <br>

              Hasta hace poco los patrones de código asíncrono consistian basicamente de
               Callbacks, lo que supone los siguientes problemas:

               <br>

              - Inversión del control.
              - Confusión de los inputs con los outputs.
              - El manejo de errores se complica considerablemente.
              - El código se vuelve difícil de mantener y entender.
          </script>
        </section>


        <!-- Slide -->
        <section data-markdown>
          <script type="text/template">
              ## El problema de Confianza

              <br>

              ```
              // (1) tu programa hasta ahora

              funcionAsincrona( function(){
                  // (2) todo tu programa despues
              });
              ```

              <br>

              ¿ Quien controla **funcionAsincrona** ?


              ¿ Puedes confiar que **funcionAsincrona** provisione y ejecute (2) correctamente ?

              ¿ Que tanto depende tu código de **funcionAsincrona** ?
          </script>
        </section>


        <!-- Slide -->
        <section class="codigoGigante">

              <h2>Ejemplo tweets con Callbacks en jQuery</h2>

              <pre><code data-trim>
// VAMOS A BUSCAR UN JSON
// parte 1: Un nuevo Callback
$.ajax({
  url: '//jsbin.com/cinuna/6.json',
  dataType: 'json',
  success: function(response){
              var json = response;
              /* Nos devuelve el siguiente json
                { tweets:
                    user: "LaViejaDeLaEsquina.com",
                    [
                      "//jsbin.com/cinuna/4.json",
                      "//jsbin.com/cinuna/5.json"
                    ]
                }
              */

              // VAMOS A BUSCAR UN JSON
              // parte 2: El Callback contraataca
              $.ajax({
                url: json.tweets[0], // "//jsbin.com/cinuna/4.json"
                dataType: 'json',
                success:  function(response){
                            var tweet1 = response;
                            // Nos devuelve el siguiente json
                            /* {body: "#MasterChefMenudeReyes Charquicán
                             (pero ÉSE Charquicán, con longaniza ¡con TODO!)"} */

                            // VAMOS A BUSCAR UN JSON
                            // parte 3: El retorno del Callback
                            $.ajax({
                              url: json.tweets[1], // "//jsbin.com/cinuna/5.json"
                              dataType: 'json',
                              success:  function(response){
                                          var tweet2 = response;
                                          // Nos devuelve el siguiente json
                                          /* {body: "A todo esto? En qué pasillo del Unimarc
                                           encuentro jabalí? #MasterChefMenuDeReyes"} */

                                          // Aqui esta el código que nos importa... ¬_¬
                                          console.log(tweet1,tweet2);
                                          // ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^
                                        },
                              error: function(err){ console.log(err); }
                            });
                },
                error: function(err){ console.log(err); }
            });
  },
  error: function(err){ console.log(err); }
});
                </code></pre>
        </section>


        <!-- Slide -->
        <section data-markdown>
          <script type="text/template">
              ## Como podemos solucionar estos problemas?

              <br>

              Las nuevas versiones de EcmaScript estan siendo implementadas en
              Browsers y Runtimes como io.js y Node.js.

              Estas incluyen Patrones e APIs nativas para manejo de
              código asíncrono de manera adecuada.
          </script>
        </section>


        <!-- Slide -->
        <section data-markdown>
          <script type="text/template">
              ## Promesas, ¿Que son?

              Una Promesa representa el resultado de una operación asincrona o diferida (aplazada)

              El objeto "Promise" se puede encontrar uno de 3 estados:

              - **pending**: estado inicial, no se ha completado ni rechazado.
              - **fulfilled**: operación finalizada correctamente.
              - **rejected**: operación fallida.
          </script>
        </section>


        <!-- Slide -->
        <section data-markdown>
          <script type="text/template">
              ## sintaxis

              ```
              var promise = new Promise(function(resolve, reject) {
                // hacer algo, posiblemente async
                muchasCosasLaRaja = true;

                if (muchasCosasLaRaja) {
                  resolve("Promesa Resuelta!");
                }
                else {
                  reject(Error("Promesa Rechazada!"));
                }
              });
              ```
          </script>
        </section>


        <!-- Slide -->
        <section data-markdown>
          <script type="text/template">
              ## Soporte Nativo en Browsers?
              <iframe src="http://caniuse.com/#feat=promises" frameborder="0"></iframe>
          </script>
        </section>


        <!-- Slide -->
        <section data-markdown>
          <script type="text/template">
              ## implementaciones (no nativas/ES6)

              - [polyfill](https://github.com/jakearchibald/es6-promise)
              - [Q](https://github.com/kriskowal/q)
              - [when](https://github.com/cujojs/when)
              - [WinJS](http://msdn.microsoft.com/en-us/library/windows/apps/br211867.aspx)
              - [RSVP.js](https://github.com/tildeio/rsvp.js)
              - [jQuery *](http://api.jquery.com/?s=Deferred)
          </script>
        </section>


        <!-- Demo -->
        <section class="code" data-jsbin="http://jsbin.com/gazicu/embed?js,console">
          <h5>Promesas: Hello World</h5>
        </section>

        <!-- Demo -->
        <section class="code" data-jsbin="http://jsbin.com/xujur/embed?js,console">
          <h5>Promesas: Bomba asincrona</h5>
        </section>

        <!-- Demo -->
        <section class="code" data-jsbin="http://jsbin.com/yohitu/embed?js,console">
          <h5>Promesas: AJAX</h5>
        </section>

        <!-- Demo -->
        <section class="code" data-jsbin="http://jsbin.com/zekin/embed?js,console">
          <h5>Promesas: Promise.all</h5>
        </section>

        <!-- Slide -->
        <section class="codigoGigante">

              <h2>Ejemplo tweets con Callbacks en jQuery</h2>

              <pre><code data-trim>
$.ajax({
  url: '//jsbin.com/cinuna/6.json',
  dataType: 'json',
  success: function(response){
              var json = response;
              $.ajax({
                url: json.tweets[0], // "//jsbin.com/cinuna/4.json"
                dataType: 'json',
                success:  function(response){
                            var tweet1 = response;
                            $.ajax({
                              url: json.tweets[1],
                              dataType: 'json',
                              success:  function(response){
                                          var tweet2 = response;
                                          console.log(tweet1,tweet2);
                                        },
                              error: function(err){ console.log(err); }
                            });
                },
                error: function(err){ console.log(err); }
            });
  },
  error: function(err){ console.log(err); }
});
                </code></pre>
        </section>

        <!-- Slide -->
        <section data-markdown>
          <script type="text/template">
              ## Ejemplo tweets con Promesas

              ```
              get('//jsbin.com/cinuna/6.json')
                .then(function(response){
                  var json = JSON.parse(response);
                  var tweetsPrometidos = [get(json.tweets[0]), get(json.tweets[1])];
                  return Promise.all(tweetsPrometidos);
                })
                .then(function(tweets){
                  for(var tweet of tweets) {
                    console.log(JSON.parse(tweet));
                  }
                })
                .catch(function(err){ console.log(err); });
              ```
          </script>
        </section>


        <!-- Slide -->
        <section data-markdown>
          <script type="text/template">
              ## Promesas vs eventos / callbacks
          </script>
        </section>


        <!-- Slide -->
        <section data-markdown>
          <script type="text/template">
              ### vs **callbacks**, las promesas nos permiten:
                - Componer y razonar claramente sobre nuestro código asíncrono.
                - Simplificar una cadena de código asíncrono.
                - Simplifican el manejo de errores en un 9000% ™ ©
                - Solucionar en gran parte el problema de inversión de control.
                - No confundir los inputs con los outputs.
          </script>
        </section>


        <!-- Slide -->
        <section data-markdown>
          <script type="text/template">
              ### vs **eventos**, las promesas nos permiten:
                - Encapsular comportamientos dependientes de condiciones asincronas/diferidas.
                - No preocuparnos de suscripcion/de-suscripcion de eventos dependientes.

              <br>
              por otro lado los eventos siguen siendo una mejor alternativa al momento de
              procesar acciones que se repetiran mucho; aunque una mezcla de los dos es mucho mejor que solo eventos
          </script>
        </section>


        <!--    Generadores    -->
        <!-- Slide -->
        <section data-markdown>
          <script type="text/template">
              ## Generadores, ¿Que son?

              Los Generadores son funciones que pueden ser pausadas y reanudadas en otro momento.

              Los Generadores retornan (generan) un objeto "Iterator" (iterador) y se pueden encontrar en uno de 4 estados:

              - **newborn**
              - **executing**
              - **suspended**
              - **closed**
          </script>
        </section>


        <!-- Slide -->
        <section data-markdown>
          <script type="text/template">
              ## Iteradores, ¿Que Son?

              Los iteradores fundamentalmente son un patrón de diseño de programas que nos permite trabajar con
              colecciones por medio de abstracciones de alto nivel (programación funcional)

              Un Iterador es un objeto que sabe como acceder a los items de una colección uno a la vez
              mientras que mantiene la referencia a su posición actual en la secuencia.
          </script>
        </section>


        <!-- Slide -->
        <section data-markdown>
          <script type="text/template">
              ### Iteradores, parte 2

              En ES6 las colecciones (arrays, maps, sets) son objetos iteradores

              Los iteradores pueden ser iterados/recorridos con:

              - for
              - for each
              - for of
              - for in
              - map()
              - filter()
              - comprensiones de colecciones/secuecias..
          </script>
        </section>


        <!-- Slide -->
        <section data-markdown>
          <script type="text/template">
              ## Sintaxis

              ```
              // la funcion foo es un generador
              function* foo() { // la sintaxis para un generador es " function* "
                  // yield cede la ejecucion, retorna el valor
                  // a la derecha y pausa el generador
                  yield 1;
                  yield 2;
                  yield 3;
              }

              var iter = foo(); // iter recibe un objeto iterador

              // next() ejecuta el iterador hasta el siguiente yield
              // dentro del mismo y retorna un objeto con el valor a la derecha de este
              iter.next(); // { value: 1, done: false }
              iter.next(); // { value: 2, done: false }
              iter.next(); // { value: 3, done: false }
              ```
          </script>
        </section>


        <!-- Slide -->
        <section data-markdown>
          <script type="text/template">
              ## Soporte Nativo en Browsers?

              <iframe src="http://kangax.github.io/compat-table/es6/#generators" frameborder="0"></iframe>
          </script>
        </section>


        <!-- Demo -->
        <section class="code" data-jsbin="http://jsbin.com/hawiba/embed?js,console">
          <h5>Generadores: Hello World</h5>
        </section>


        <!-- Demo -->
        <section class="code" data-jsbin="http://jsbin.com/duyuta/embed?js,console">
          <h5>Generadores: Generando Iteradores</h5>
        </section>


        <!-- Demo -->
        <section class="code" data-jsbin="http://jsbin.com/revunu/embed?js,console">
          <h5>Generadores: Iterando Iteradores</h5>
        </section>


        <!-- Demo -->
        <section class="code" data-jsbin="http://jsbin.com/sokogi/embed?js,console">
          <h5>Generadores: Colecciones Flojas</h5>
        </section>


        <!-- Demo -->
        <section class="code" data-jsbin="http://jsbin.com/lapana/embed?js,console">
          <h5>Generadores: Insercion de Valores</h5>
        </section>


        <!-- Demo -->
        <section class="code" data-jsbin="http://jsbin.com/sixatibitu/embed?js,console">
          <h5>Generadores: Control de Flujo</h5>
        </section>


        <!-- Demo -->
        <section class="code" data-jsbin="http://jsbin.com/tomutelide/embed?js,console">
          <h5>Generadores: Delegando Iteradores</h5>
        </section>


        <!--    ASYNC    -->
        <!-- Slide -->
        <section data-markdown>
          <script type="text/template">
              ## Funciones Asincronas, ¿Que son?
              **Draft para ES7**

              la funcion Async permite esperar( ```await``` ) una promesa
              pausando la ejecucion sin bloquear. Al resolverse la promesa retorna el valor.

              [https://github.com/lukehoban/ecmascript-asyncawait]
          </script>
        </section>


        <!-- Slide -->
        <section data-markdown>
          <script type="text/template">
              ## Sintaxis
              ```
              async function loadStory() {
                try {
                  // await espera a que la llamada asincrona
                  // se complete antes de entregar el valor
                  let story = await getJSON('story.json');
                  addHtmlToPage(story.heading);
                  for (let chapter of story.chapterURLs.map(getJSON)) {
                    addHtmlToPage((await chapter).html);
                  }
                  console.log("OK!");
                } catch (err) {
                  console.log("Algo se rompio!: " + err.message);
                }
                document.querySelector('.spinner').style.display = 'none';
              }
              ```
          </script>
        </section>


        <!-- Slide -->
        <section data-markdown>
          <script type="text/template">
              ## Polyfill

              Ya que Async / Await es solo un draft para ES7, si queremos aprovechar sus beneficios
              debemos ocupar un polyfill proporcionado por alguna libreria o transpilador

              tambien podemos ocupar una funcion simple como spawn (demostrada en el demo)
          </script>
        </section>


        <!-- Demo -->
        <section class="code" data-jsbin="http://jsbin.com/hojakovese/embed?js,console">
          <h5>Async / Await: tweets</h5>
        </section>


        <!-- Slide -->
        <section data-markdown>
          <script type="text/template">
              ## Ejemplo tweets con Promesas

              ```
              get('//jsbin.com/cinuna/6.json')
                .then(function(response){
                  var json = JSON.parse(response);
                  var tweetsPrometidos = [get(json.tweets[0]), get(json.tweets[1])];
                  return Promise.all(tweetsPrometidos);
                })
                .then(function(tweets){
                  for(var tweet of tweets) {
                    console.log(JSON.parse(tweet));
                  }
                })
                .catch(function(err){ console.log(err); });
              ```
          </script>
        </section>


        <!-- Slide -->
        <section data-markdown>
          <script type="text/template">
              ## Ejemplo tweets con Async / Await

              ```
              spawn(function* () {
                try {
                  var data = yield get('//jsbin.com/cinuna/6.json');
                  var j = JSON.parse(data);
                  var tweets = yield Promise.all([get(j.tweets[0]), get(j.tweets[1])]);

                  for(var tweet of tweets) { console.log(JSON.parse(tweet)); }
                }
                catch (err){ console.log(err); }
              });
              ```
          </script>
        </section>


        <!-- Slide -->
        <section data-markdown>
          <script type="text/template">
              ## Ejemplo tweets con Async / Await v2

              ```
              var getTweets = spawn(function* () {
                try {
                  var data = yield get('//jsbin.com/cinuna/6.json');
                  var j = JSON.parse(data);
                  var tweets = yield Promise.all([get(j.tweets[0]), get(j.tweets[1])]);
                  return tweets;
                }
                catch (err){ return(err); }
              });

              getTweets.then(function(tweets){
                for(var tweet of tweets) { console.log(JSON.parse(tweet)); }
              });
              ```
          </script>
        </section>


        <!-- Slide -->
        <section>

          <h3>Podemos pensar en estas caracteristicas de ES6/7</h3>
          <h3>de la siguiente manera:</h3>

          <br>

          <table>
            <thead>
            <tr>
            <th></th>
            <th align="center">Sync</th>
            <th align="center">Async</th>
            </tr>
            </thead>
            <tbody>
            <tr>
            <td>function</td>
            <td align="center">T</td>
            <td align="center">Promise</td>
            </tr>
            <tr>
            <td>function*</td>
            <td align="center">Iterator</td>
            <td align="center">???</td>
            </tr>
            </tbody>
          </table>

          <br>
          <p>La pregunta es: "¿Que nos devuelve un generador asíncrono?"</p>
        </section>


        <!-- Slide -->
        <section>
          <img src="img/deeper.jpg" alt="">
        </section>


        <!--    ASYNC GENERATORS    -->
        <!-- Slide -->
        <section data-markdown>
          <script type="text/template">
              ## Generadores Asíncronos, ¿Que son?
              **Draft para ES7**


              Los Generadores Asíncronos nos permiten consumir una coleccion de valores asincrona
              como si se tratara de una coleccion sincrona.


              Los Generadores Asíncronos nos devuelven un tipo "Observable"

              [https://github.com/jhusain/asyncgenerator]
          </script>
        </section>


        <!--    ASYNC GENERATORS    -->
        <!-- Slide -->
        <section data-markdown>
          <script type="text/template">
              ## Ejemplo Drag & drop

              Los Generadores Asíncronos aun no tienen una API definida, polyfill o transpilacion a ES5

              Pero nos permitiran escribir operaciónes asincronas complejas, de una manera declarativa y clara.

              ```
              function getMouseDrags(elmt) {
                var mouseDowns = Observable.fromEvent(elmt, "mousedown"),
                var documentMouseMoves = Observable.fromEvent(document.body, "mousemove"),
                var documentMouseUps = Observable.fromEvent(document.body, "mouseup");

                return mouseDowns.concatMap(mouseDown =>
                  documentMouseMoves.takeUntil(documentMouseUps));
              };

              var image = document.createElement("img");
              document.body.appendChild(image);

              getMouseDrags(image).forEach(dragEvent => {
                image.style.left = dragEvent.clientX;
                image.style.top = dragEvent.clientY;
              });
              ```
          </script>
        </section>


        <!-- Slide -->
        <section data-markdown>
          <script type="text/template">
              ## Ejemplo Observacion Asincrona

              Incluso podremos declarar operaciónes de Observacion Asincrona.

              ```
              async function testFn() {
                var writer = new AsyncStreamWriter("/...");

                for(var x on new AsyncStreamReader("/...")) {
                  await writer.write(x);
                }
              }
              ```

              <small>(HYPE... claxon claxon---)</small>
          </script>
        </section>


        <!-- Slide -->
        <section data-markdown>
          <script type="text/template">
            <img src="img/future.jpg" alt="">
          </script>
        </section>


        <!--    FIN    -->
      <section data-markdown>
          <script type="text/template">
              ## Gracias

              <small>http://goo.gl/86v9kK</small>

              ![http://goo.gl/86v9kK](http://chart.googleapis.com/chart?cht=qr&chs=150x150&choe=UTF-8&chld=H&chl=http://goo.gl/86v9kK)

              <small>contribuciones y correcciones en <br> https://github.com/burabure/tut-ES6-promises-generators</small>

              <small class="profile"><div class="avatar"></div>Bura Bure (Nicolás Fernández) <br> CTOWTFOMGBBQ!!1! en [SantiagoLab.cl](http://santiagolab.cl)</small>

              <small>2015</small>
          </script>
        </section>

      </div>

    </div>

    <script src="js/jsbin.js"></script>
    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.min.js"></script>

    <script src="//code.jquery.com/jquery-1.11.2.min.js"></script>

    <script>
      // Full list of configuration options available here:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        width: "100%",
        height: "100%",
        margin: 0,
        controls: true,
        progress: true,
        history: true,
        center: true,

        theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
        transition: 'default', // default/cube/page/concave/zoom/linear/fade/none

        // Parallax scrolling
        // parallaxBackgroundImage: 'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg',
        // parallaxBackgroundSize: '2100px 900px',

        // Optional libraries used to extend on reveal.js
        dependencies: [
          { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
          //{ src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
          { src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
        ]
      });
    </script>

    <script>
      Reveal.addEventListener( 'ready', function( event ) {
        // event.currentSlide, event.indexh, event.indexv
        $('section:not(.code)').wrapInner('<div class="content">');
      });

      Reveal.addEventListener( 'slidechanged', function( event ) {
        // console.log( event.currentSlide);
        window.slide = event.currentSlide;
        if(event.currentSlide.getAttribute("data-jsbin"))
          jsBin.embed(event.currentSlide);

          titleHeight = $('h5', event.currentSlide).outerHeight(true) || 0;
          $('iframe', event.currentSlide).css({
            'max-height': $(event.currentSlide).height() - titleHeight - parseInt($(event.currentSlide).css('padding-top')) - $('.progress').outerHeight(true),
            'top': titleHeight + parseInt($(event.currentSlide).css('padding-top'), 10)
          });

        if(event.previousSlide && event.previousSlide.getAttribute("data-jsbin"))
          $('iframe', event.previousSlide).remove();
      });
    </script>

  </body>
</html>
